<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RHUL Food Finder</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="custom.css">
    <link rel="stylesheet" href="index.css">
    <link rel="icon" href="img/icon.png">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <meta name="description" content="A simple tool (still in beta) to find the nearest place on campus that is open and that you can get food from at Royal Holloway, Univeristy of London">
    <script
            src="https://code.jquery.com/jquery-3.2.1.min.js"
            integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.8/handlebars.js" integrity="sha256-1a54WaWEbX3FFsS2Ko6dUSj50JUeH/KeLY5IU2HbIBg=" crossorigin="anonymous"></script>

    <script>
        if ('serviceWorker' in navigator) {
            console.log('CLIENT: service worker registration in progress.');
            navigator.serviceWorker.register('./service_worker.js').then(function() {
                console.log('CLIENT: service worker registration complete.');
            }, function() {
                console.log('CLIENT: service worker registration failure.');
            });
        } else {
            console.log('CLIENT: service worker is not supported.');
        }
    </script>
</head>
<body>
<!-- Always shows a header, even in smaller screens. -->
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <header class="mdl-layout__header">
        <div class="mdl-layout__header-row">
            <!-- Title -->
            <img style="height:3em;padding-right: 1em" src="img/icon.svg">
            <span class="mdl-layout-title">RHUL Food Finder</span>
            <div class="mdl-layout-spacer"></div>
            <select id="daySelect" onchange="direct(value);">
            </select>
        </div>
    </header>
    <main class="mdl-layout__content">
        <div class="mdl-grid">
        <div class="mdl-layout-spacer"></div>
        <div class="mdl-cell--10-col mdl-cell mdl-grid" id="pageContent">
        </div>
        <div class="mdl-layout-spacer"></div>
        </div>
    </main>
</div>
</body>
<script>
    function direct(value) {
        if (value == -1) {
            today();
        } else {
            render_day(value, true);
        }
    }
    Handlebars.registerHelper('time', function(arg) {
        var time = new Date(today_midnight().getTime() + (arg * 1000));
        return time.toLocaleTimeString().substr(0,5);
    });
    const DAYS = [
            "Sunday",
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday",
            "Saturday"
    ];
    var selector = $("#daySelect");
    var today = $("<option/>", {"value": "-1"});
    today.text("Today");
    today.appendTo(selector);
    for (index in DAYS) {
        var option = $("<option/>");
        option.attr("value", index);
        var dayName = DAYS[index];
        option.text(dayName);
        option.appendTo(selector);
    }

    var $pageContent = $("#pageContent");
    function today_midnight() {
        var date = new Date();
        date.setHours(0);
        date.setMinutes(0);
        date.setSeconds(0);
        date.setMilliseconds(0);
        return date;
    }
    function render(data, template_text, future, day_number, now) {
        function renderDay(day_number, future) {
            $pageContent.empty();
            var currentTime;
            if (!future) {
                var date = today_midnight();
                currentTime = (now.getTime() - date.getTime()) / 1000;
            }
            $.each(data, function (key, value) {
                var hours = value["hours"][DAYS[day_number]];
                var data = {
                    "location": value,
                    "hours": hours
                };
                if (future) {
                    data["future"] = true;
                } else {
                    var open = false;
                    $.each(hours, function (_, data) {
                        if (data[0] < currentTime && data[1] > currentTime) {
                            open = true;
                        }
                    });
                    if (open) {
                        data["open"] = true;
                    } else {
                        data["closed"] = true;
                    }
                }
                var template = Handlebars.compile(template_text);
                var newCell = $("<div/>", {
                    "class": "mdl-cell--4-col mdl-cell demo-card-wide mdl-card mdl-shadow--2dp"
                });
                newCell.html(template(data));
                newCell.appendTo($pageContent);
            });
        }
        today = function() {renderDay(day_number, false)};
        render_day = renderDay;
        today();
    }

    $.get("data.json", function (data) {
        $.get("place.hbs", null, function (template) {
            var now = new Date();
            render(data, template, false, now.getDay(), now);
        }, 'html');
    });
</script>
</html>